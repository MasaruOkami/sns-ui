<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial,
          "YuGothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", sans-serif;
        margin: 0;
        padding: 16px;
        background: #f5f5f7;
      }
      .container {
        max-width: 560px;
        margin: 0 auto;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.06);
        padding: 16px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .meta {
        font-size: 12px;
        color: #777;
        margin-bottom: 16px;
      }

      .section {
        margin-top: 16px;
      }
      .step-label {
        font-size: 11px;
        font-weight: 700;
        color: #ff6a3d;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .section-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .media {
        margin: 4px 0 12px;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
        position: relative;
      }
      .media img {
        width: 100%;
        display: block;
        object-fit: cover;
      }
      .media-placeholder {
        padding: 40px 16px;
        text-align: center;
        color: #aaa;
        font-size: 12px;
        background: #111;
      }

      .caption-label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
      }
      .caption-text,
      .hashtags {
        font-size: 14px;
        line-height: 1.7;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .hashtags {
        margin-top: 8px;
      }

      .actions {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .btn-primary {
        background: linear-gradient(135deg, #ff7a00, #ff0069);
        color: #fff;
      }
      .btn-secondary {
        background: #f0f0f5;
        color: #333;
      }
      .btn-ghost {
        background: #ffffff;
        color: #333;
        border: 1px solid #ddd;
      }

      .hint {
        margin-top: 10px;
        font-size: 11px;
        color: #777;
      }
      .hint-small {
        margin-top: 6px;
        font-size: 11px;
        color: #888;
      }
      .error {
        margin-top: 12px;
        font-size: 13px;
        color: #c62828;
      }
      .loading {
        font-size: 13px;
        color: #555;
      }

      /* === STEP 2.5 ãƒãƒƒãƒ—UI === */
      .chip-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        border: 1px solid #d9d9de;
        background: #fff;
        color: #333;
        border-radius: 14px;
        padding: 12px 14px;
        font-size: 13px;
        min-height: 44px; /* ã‚¹ãƒãƒ›æŠ¼ã—ã‚„ã™ã• */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }
      .chip:hover { background: #fafafa; }
      .chip:disabled { opacity: 0.45; cursor: not-allowed; }
      .chip-ok {
        border-color: #bfe5c8;
        background: #f2fbf5;
        font-weight: 600;
      }
    </style>

    <!-- supabase-js v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <div class="title">SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div id="meta" class="meta"></div>

        <!-- STEP 1: ç”»åƒã‚’ä¿å­˜ -->
        <div class="section">
          <div class="step-label">STEP 1</div>
          <div class="section-title">ç”»åƒã‚’ä¿å­˜</div>

          <div class="media" id="media">
            <div class="media-placeholder" id="media-placeholder">
              ç”»åƒãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br />
              generated_media_url ã¾ãŸã¯ Storage ã®ç”»åƒãŒå…¥ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-ghost" id="open-image-btn" disabled>
              ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ã
            </button>
          </div>
          <div class="hint-small" id="image-hint" style="display: none;">
            ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç”»åƒã‚’å…¨ç”»é¢è¡¨ç¤ºã—ã€é•·æŠ¼ã—ã§ã€Œå†™çœŸã‚’ä¿å­˜ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
          </div>
        </div>

        <!-- STEP 2: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ -->
        <div class="section">
          <div class="step-label">STEP 2</div>
          <div class="section-title">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼</div>

          <div class="caption-label">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</div>
          <div id="caption" class="caption-text loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div id="hashtags" class="hashtags"></div>

          <div class="actions">
            <button class="btn btn-primary" id="copy-btn">
              ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼
            </button>
          </div>
        </div>

        <!-- STEP 2.5: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå†ç”Ÿæˆï¼‰ -->
        <div class="section">
          <div class="step-label">STEP 2.5</div>
          <div class="section-title">æ–‡ç« ã‚’å¾®èª¿æ•´ï¼ˆå†ç”Ÿæˆï¼‰</div>

          <div class="chip-grid">
            <button class="chip chip-ok" id="ok-btn" type="button" disabled>âœ… ã“ã®å†…å®¹ã§OK</button>

            <button class="chip" data-action="shorter_text" type="button" disabled>âœ‚ï¸ æ–‡ç« ã‚’çŸ­ã</button>
            <button class="chip" data-action="longer_text" type="button" disabled>ğŸ“ æ–‡ç« ã‚’é•·ã</button>

            <button class="chip" data-action="less_emoji" type="button" disabled>ğŸ˜ƒ çµµæ–‡å­—ã‚’æ¸›ã‚‰ã™</button>
            <button class="chip" data-action="more_emoji" type="button" disabled>ğŸ˜ƒ çµµæ–‡å­—ã‚’å¢—ã‚„ã™</button>

            <button class="chip" data-action="softer_tone" type="button" disabled>âœï¸ ã‚„ã‚ã‚‰ã‹ã</button>
            <button class="chip" data-action="more_formal" type="button" disabled>ğŸ§‘â€ğŸ’¼ ã‚‚ã£ã¨ä¸å¯§ã«</button>
            <button class="chip" data-action="more_friendly" type="button" disabled>ğŸ˜Š è¦ªã—ã¿ã‚„ã™ã</button>

            <button class="chip" data-action="adjust_hashtags" type="button" disabled>#ï¸âƒ£ ã‚¿ã‚°èª¿æ•´</button>
          </div>

          <div class="hint-small" id="feedback-hint">
            ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ•°ç§’å¾Œã«ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <!-- STEP 3: Instagram ã‚’é–‹ã -->
        <div class="section">
          <div class="step-label">STEP 3</div>
          <div class="section-title">Instagram ã«è²¼ã‚Šä»˜ã‘</div>
          <div class="actions">
            <button class="btn btn-secondary" id="open-instagram">
              Instagram ã‚’é–‹ã
            </button>
          </div>
        </div>

        <div id="hint" class="hint">
          1. ã¾ãšã€Œç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ãã€ã§ç”»åƒã‚’ä¿å­˜<br />
          2. æ¬¡ã«ã€Œã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã€<br />
          3. æœ€å¾Œã« Instagram ã‚’é–‹ãã€æŠ•ç¨¿ç”»é¢ã§ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„
        </div>

        <div id="error" class="error" style="display: none;"></div>
      </div>
    </div>

    <script>
      // âœ… ã‚ãªãŸã® Supabase æƒ…å ±
      const SUPABASE_URL = "https://xzhavuhjpfwsrljkpyrv.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6aGF2dWhqcGZ3c3JsamtweXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODg4MDMsImV4cCI6MjA3Nzg2NDgwM30.h2k2gnOcqme4JSg7VEkpqbIwh27OmdTqX_HkIUTniU4";

      const FUNCTIONS_BASE_URL = `${SUPABASE_URL}/functions/v1`;

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const params = new URLSearchParams(window.location.search);
      const planId = params.get("plan_id");

      const metaEl = document.getElementById("meta");
      const captionEl = document.getElementById("caption");
      const hashtagsEl = document.getElementById("hashtags");
      const errorEl = document.getElementById("error");
      const mediaEl = document.getElementById("media");
      const mediaPlaceholderEl = document.getElementById("media-placeholder");
      const copyBtn = document.getElementById("copy-btn");
      const openInstagramBtn = document.getElementById("open-instagram");
      const openImageBtn = document.getElementById("open-image-btn");
      const imageHintEl = document.getElementById("image-hint");
      const okBtn = document.getElementById("ok-btn");

      let currentMediaUrl = null;

      function normalizeHashtags(hashtagsArr) {
        return (hashtagsArr || [])
          .map((h) => String(h || "").trim())
          .filter(Boolean)
          .map((h) => (h.startsWith("#") ? h : `#${h}`))
          .join(" ");
      }

      function renderCaptionAndHashtags(caption, hashtagsArr) {
        captionEl.textContent = caption || "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒæœªè¨­å®šã§ã™ã€‚";
        const hashtags = normalizeHashtags(hashtagsArr);
        hashtagsEl.textContent = hashtags;

        const fullText = `${captionEl.textContent}\n\n${hashtags}`;
        copyBtn.dataset.fulltext = fullText;
      }

      function setFeedbackButtonsEnabled(enabled) {
        document.querySelectorAll("button[data-action], #ok-btn").forEach((btn) => {
          btn.disabled = !enabled;
        });
      }

      if (!planId) {
        captionEl.textContent = "";
        errorEl.style.display = "block";
        errorEl.textContent =
          "plan_id ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚";
        copyBtn.disabled = true;
        openImageBtn.disabled = true;
        setFeedbackButtonsEnabled(false);
      } else {
        setFeedbackButtonsEnabled(false);
        loadPlan(planId);
      }

      async function loadPlan(planId) {
        try {
          captionEl.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
          hashtagsEl.textContent = "";
          errorEl.style.display = "none";

          // 1) ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆmedia_id ã‚‚å–ã‚‹ï¼‰
          const { data: plan, error: planError } = await client
            .from("sns_post_plans")
            .select(
              "store_id, platform, media_kind, scheduled_at, caption, hashtags, generated_media_url, posted_url, media_id"
            )
            .eq("plan_id", planId)
            .single();

          if (planError || !plan) {
            console.error(planError);
            captionEl.textContent = "";
            errorEl.style.display = "block";
            errorEl.textContent =
              "ãƒ—ãƒ©ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒ³ã‚¯ãŒå¤ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
            copyBtn.disabled = true;
            openImageBtn.disabled = true;
            setFeedbackButtonsEnabled(false);
            return;
          }

          // ãƒ¡ã‚¿æƒ…å ±
          const dt = plan.scheduled_at ? new Date(plan.scheduled_at) : null;
          const dtStr = dt
            ? `${dt.getFullYear()}/${String(dt.getMonth() + 1).padStart(2,"0")}/${String(dt.getDate()).padStart(2,"0")} ${String(dt.getHours()).padStart(2,"0")}:${String(dt.getMinutes()).padStart(2,"0")}`
            : "æ—¥æ™‚æœªè¨­å®š";

          metaEl.textContent = `${plan.store_id} / ${plan.platform} / ${plan.media_kind} / ${dtStr}`;

          // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°
          renderCaptionAndHashtags(plan.caption || "", plan.hashtags || []);

          // 2) ç”»åƒURLã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
          let finalMediaUrl = null;

          if (plan.generated_media_url) {
            finalMediaUrl = plan.generated_media_url;
          } else if (plan.media_id) {
            const { data: asset, error: assetError } = await client
              .from("sns_media_assets")
              .select("storage_bucket, storage_key")
              .eq("media_id", plan.media_id)
              .maybeSingle();

            if (assetError) console.error("assetError", assetError);

            if (asset && asset.storage_bucket && asset.storage_key) {
              const { data: publicUrlData } = client.storage
                .from(asset.storage_bucket)
                .getPublicUrl(asset.storage_key);

              if (publicUrlData && publicUrlData.publicUrl) {
                finalMediaUrl = publicUrlData.publicUrl;
              }
            }
          }

          currentMediaUrl = finalMediaUrl;

          if (finalMediaUrl) {
            const img = document.createElement("img");
            img.src = finalMediaUrl;
            img.alt = "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ";
            mediaEl.innerHTML = "";
            mediaEl.appendChild(img);

            openImageBtn.disabled = false;
            imageHintEl.style.display = "block";
          } else {
            // mediaElãŒimgã§ç½®ãæ›ã‚ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§å®‰å…¨ã«æˆ»ã™
            mediaEl.innerHTML = "";
            const ph = document.createElement("div");
            ph.className = "media-placeholder";
            ph.id = "media-placeholder";
            ph.textContent = "ç”»åƒURLãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
            mediaEl.appendChild(ph);

            openImageBtn.disabled = true;
            imageHintEl.style.display = "none";
          }

          // âœ… planãŒèª­ã‚ãŸã‚‰ãƒœã‚¿ãƒ³ON
          setFeedbackButtonsEnabled(true);

        } catch (e) {
          console.error(e);
          captionEl.textContent = "";
          errorEl.style.display = "block";
          errorEl.textContent = "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
          copyBtn.disabled = true;
          openImageBtn.disabled = true;
          setFeedbackButtonsEnabled(false);
        }
      }

      // STEP2: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚³ãƒ”ãƒ¼
      copyBtn.addEventListener("click", async () => {
        const full = copyBtn.dataset.fulltext || "";
        try {
          await navigator.clipboard.writeText(full);
          copyBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
          setTimeout(() => {
            copyBtn.textContent = "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼";
          }, 1800);
        } catch (e) {
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
          console.error(e);
        }
      });

      async function callFeedback(action) {
        const res = await fetch(`${FUNCTIONS_BASE_URL}/sns-preview-feedback`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            plan_id: planId,
            action,
          }),
        });

        const json = await res.json();
        if (!res.ok) {
          throw new Error(json?.error || "feedback failed");
        }
        return json; // { caption, hashtags, ... }
      }

      // âœ… å…¨ãƒœã‚¿ãƒ³å…±é€šãƒãƒ³ãƒ‰ãƒ©ï¼ˆdata-actionï¼‰
      document.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!planId) return;
          const action = btn.dataset.action;
          if (!action) return;

          const prevText = btn.textContent;

          try {
            setFeedbackButtonsEnabled(false);
            btn.textContent = "ç”Ÿæˆä¸­...";

            const out = await callFeedback(action);

            renderCaptionAndHashtags(out.caption, out.hashtags);

            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
          } catch (e) {
            console.error(e);
            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
            alert(`å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e?.message || e}`);
          }
        });
      });

      // âœ… OKãƒœã‚¿ãƒ³ï¼ˆä»Šã¯MVPï¼šã¨ã‚Šã‚ãˆãšé€šçŸ¥ã ã‘ï¼‰
      okBtn.addEventListener("click", () => {
        alert("OKï¼ˆç¢ºå®šï¼‰ã®å‡¦ç†ã¯æ¬¡ã«è¿½åŠ ã§ãã¾ã™ï¼ˆä¾‹ï¼šsns_post_plans.status='approved'ï¼‰ã€‚");
      });

      // STEP1: ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ã
      openImageBtn.addEventListener("click", () => {
        if (!currentMediaUrl) return;
        window.open(currentMediaUrl, "_blank");
      });

      // STEP3: Instagram ã‚’é–‹ã
      openInstagramBtn.addEventListener("click", () => {
        window.location.href = "instagram://app";
        setTimeout(() => {
          window.location.href = "https://www.instagram.com/";
        }, 1200);
      });
    </script>
  </body>
</html>
