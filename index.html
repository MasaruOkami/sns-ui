<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial,
          "YuGothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", sans-serif;
        margin: 0;
        padding: 16px;
        background: #f5f5f7;
      }
      .container { max-width: 560px; margin: 0 auto; }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.06);
        padding: 16px;
      }
      .title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
      .meta { font-size: 12px; color: #777; margin-bottom: 16px; }

      .section { margin-top: 16px; }
      .step-label {
        font-size: 11px;
        font-weight: 700;
        color: #ff6a3d;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .section-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; }

      .media {
        margin: 4px 0 12px;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
        position: relative;
      }
      .media img {
        width: 100%;
        display: block;
        object-fit: cover;
      }
      .media-placeholder {
        padding: 40px 16px;
        text-align: center;
        color: #aaa;
        font-size: 12px;
        background: #111;
      }

      .caption-label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 4px; }
      .caption-text, .hashtags {
        font-size: 14px;
        line-height: 1.7;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .hashtags { margin-top: 8px; }

      .actions {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .btn-primary { background: linear-gradient(135deg, #ff7a00, #ff0069); color: #fff; }
      .btn-secondary { background: #f0f0f5; color: #333; }
      .btn-ghost { background: #ffffff; color: #333; border: 1px solid #ddd; }

      .hint { margin-top: 10px; font-size: 11px; color: #777; }
      .hint-small { margin-top: 6px; font-size: 11px; color: #888; }
      .error { margin-top: 12px; font-size: 13px; color: #c62828; }
      .loading { font-size: 13px; color: #555; }

      /* === STEP 2.5 ãƒãƒƒãƒ—UI === */
      .chip-grid { display: flex; flex-wrap: wrap; gap: 8px; }
      .chip {
        border: 1px solid #d9d9de;
        background: #fff;
        color: #333;
        border-radius: 14px;
        padding: 12px 14px;
        font-size: 13px;
        min-height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }
      .chip:hover { background: #fafafa; }
      .chip:disabled { opacity: 0.45; cursor: not-allowed; }
      .chip-ok {
        border-color: #bfe5c8;
        background: #f2fbf5;
        font-weight: 600;
      }
    </style>

    <!-- supabase-js v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <div class="title">SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div id="meta" class="meta"></div>

        <!-- STEP 1: ç”»åƒã‚’ä¿å­˜ -->
        <div class="section">
          <div class="step-label">STEP 1</div>
          <div class="section-title">ç”»åƒã‚’ä¿å­˜</div>

          <div class="media" id="media">
            <div class="media-placeholder" id="media-placeholder">
              ç”»åƒãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br />
              ç”Ÿæˆå¾Œã«ã“ã“ã¸è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-ghost" id="open-image-btn" disabled>ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ã</button>
          </div>
          <div class="hint-small" id="image-hint" style="display:none;">
            ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç”»åƒã‚’å…¨ç”»é¢è¡¨ç¤ºã—ã€é•·æŠ¼ã—ã§ã€Œå†™çœŸã‚’ä¿å­˜ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
          </div>
        </div>

        <!-- STEP 2: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ -->
        <div class="section">
          <div class="step-label">STEP 2</div>
          <div class="section-title">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼</div>

          <div class="caption-label">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</div>
          <div id="caption" class="caption-text loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div id="hashtags" class="hashtags"></div>

          <div class="actions">
            <button class="btn btn-primary" id="copy-btn">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
        </div>

        <!-- STEP 2.5: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå†ç”Ÿæˆï¼‰ -->
        <div class="section">
          <div class="step-label">STEP 2.5</div>
          <div class="section-title">æ–‡ç« ãƒ»ç”»åƒã‚’å¾®èª¿æ•´ï¼ˆå†ç”Ÿæˆï¼‰</div>

          <div class="chip-grid" style="margin-top:10px;">
            <!-- ãƒ†ã‚­ã‚¹ãƒˆç³» -->
            <button class="chip" data-action="shorter_text" type="button" disabled>âœ‚ çŸ­ã</button>
            <button class="chip" data-action="longer_text" type="button" disabled>ğŸ“ é•·ã</button>

            <button class="chip" data-action="less_emoji" type="button" disabled>ğŸ˜¶ çµµæ–‡å­—â†“</button>
            <button class="chip" data-action="more_emoji" type="button" disabled>ğŸ˜ƒ çµµæ–‡å­—â†‘</button>

            <button class="chip" data-action="softer_tone" type="button" disabled>âœï¸ ã‚„ã‚ã‚‰ã‹ã</button>
            <button class="chip" data-action="more_formal" type="button" disabled>ğŸ§‘â€ğŸ’¼ ä¸å¯§ã«</button>
            <button class="chip" data-action="more_friendly" type="button" disabled>ğŸ˜Š è¦ªã—ã¿</button>

            <button class="chip" data-action="adjust_hashtags" type="button" disabled>#ï¸âƒ£ ã‚¿ã‚°èª¿æ•´</button>

            <!-- ç”»åƒï¼šè¢«å†™ä½“ -->
            <button class="chip" data-action="img_subject_food" type="button" disabled>ğŸ½ æ–™ç†ãƒ¡ã‚¤ãƒ³</button>
            <button class="chip" data-action="img_subject_drink" type="button" disabled>ğŸ» ãƒ‰ãƒªãƒ³ã‚¯ãƒ¡ã‚¤ãƒ³</button>
            <button class="chip" data-action="img_subject_interior" type="button" disabled>ğŸ  åº—å†…ãƒ¡ã‚¤ãƒ³</button>
            <button class="chip" data-action="img_subject_staff" type="button" disabled>ğŸ™‚ ã‚¹ã‚¿ãƒƒãƒ•æ„Ÿ</button>

            <!-- ç”»åƒï¼šæ§‹å›³ -->
            <button class="chip" data-action="img_shot_closeup" type="button" disabled>ğŸ” ã‚‚ã£ã¨å¯„ã‚‹</button>
            <button class="chip" data-action="img_shot_wide" type="button" disabled>ğŸ§­ ã‚‚ã£ã¨å¼•ã</button>
            <button class="chip" data-action="img_angle_change" type="button" disabled>ğŸ“ è§’åº¦å¤‰æ›´</button>
            <button class="chip" data-action="img_clean_background" type="button" disabled>ğŸ§¼ èƒŒæ™¯ã™ã£ãã‚Š</button>

            <!-- ç”»åƒï¼šé›°å›²æ°— -->
            <button class="chip" data-action="img_mood_bright" type="button" disabled>â˜€ï¸ æ˜ã‚‹ã</button>
            <button class="chip" data-action="img_mood_calm" type="button" disabled>ğŸŒ™ è½ã¡ç€ã</button>
            <button class="chip" data-action="img_mood_luxury" type="button" disabled>âœ¨ é«˜ç´šæ„Ÿ</button>
            <button class="chip" data-action="img_mood_pop" type="button" disabled>ğŸ“¸ æ˜ ãˆ</button>

            <!-- ç”»åƒï¼šãƒ†ã‚­ã‚¹ãƒˆ -->
            <button class="chip" data-action="img_text_on" type="button" disabled>ğŸ· ãƒ†ãƒ­ãƒƒãƒ—æœ‰</button>
            <button class="chip" data-action="img_text_off" type="button" disabled>ğŸš« ãƒ†ãƒ­ãƒƒãƒ—ç„¡</button>

            <!-- ç”»åƒï¼šæºã‚‰ã -->
            <button class="chip" data-action="img_variation" type="button" disabled>ğŸ² åˆ¥æ¡ˆ</button>

            <!-- OK -->
            <button class="chip chip-ok" id="ok-btn" type="button" disabled>âœ… ã“ã‚Œã§OK</button>
          </div>

          <div class="hint-small">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ•°ç§’å¾Œã«ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³/ç”»åƒãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚</div>
        </div>

        <!-- STEP 3: Instagram ã‚’é–‹ã -->
        <div class="section">
          <div class="step-label">STEP 3</div>
          <div class="section-title">Instagram ã«è²¼ã‚Šä»˜ã‘</div>
          <div class="actions">
            <button class="btn btn-secondary" id="open-instagram">Instagram ã‚’é–‹ã</button>
          </div>
        </div>

        <div id="hint" class="hint">
          1. ã¾ãšã€Œç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ãã€ã§ç”»åƒã‚’ä¿å­˜<br />
          2. æ¬¡ã«ã€Œã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã€<br />
          3. æœ€å¾Œã« Instagram ã‚’é–‹ãã€æŠ•ç¨¿ç”»é¢ã§ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„
        </div>

        <div id="error" class="error" style="display:none;"></div>
      </div>
    </div>

    <script>
      // âœ… ã‚ãªãŸã® Supabase æƒ…å ±
      const SUPABASE_URL = "https://xzhavuhjpfwsrljkpyrv.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6aGF2dWhqcGZ3c3JsamtweXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODg4MDMsImV4cCI6MjA3Nzg2NDgwM30.h2k2gnOcqme4JSg7VEkpqbIwh27OmdTqX_HkIUTniU4";

      const FUNCTIONS_BASE_URL = `${SUPABASE_URL}/functions/v1`;

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const params = new URLSearchParams(window.location.search);
      const planId = params.get("plan_id");

      const metaEl = document.getElementById("meta");
      const captionEl = document.getElementById("caption");
      const hashtagsEl = document.getElementById("hashtags");
      const errorEl = document.getElementById("error");
      const mediaEl = document.getElementById("media");
      const copyBtn = document.getElementById("copy-btn");
      const openInstagramBtn = document.getElementById("open-instagram");
      const openImageBtn = document.getElementById("open-image-btn");
      const imageHintEl = document.getElementById("image-hint");

      let currentMediaUrl = null;

      function normalizeHashtags(hashtagsArr) {
        return (hashtagsArr || [])
          .map((h) => String(h || "").trim())
          .filter(Boolean)
          .map((h) => (h.startsWith("#") ? h : `#${h}`))
          .join(" ");
      }

      function renderCaptionAndHashtags(caption, hashtagsArr) {
        captionEl.textContent = caption || "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒæœªè¨­å®šã§ã™ã€‚";
        const hashtags = normalizeHashtags(hashtagsArr);
        hashtagsEl.textContent = hashtags;

        const fullText = `${captionEl.textContent}\n\n${hashtags}`;
        copyBtn.dataset.fulltext = fullText;
      }

      function setFeedbackButtonsEnabled(enabled) {
        document.querySelectorAll("button[data-action], #ok-btn").forEach((btn) => {
          btn.disabled = !enabled;
        });
      }

      // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼ˆç”»åƒãŒæ›´æ–°ã•ã‚Œãªã„å•é¡Œã®æœ¬ä¸¸ï¼‰
      function withCacheBust(url) {
        if (!url) return url;
        const sep = url.includes("?") ? "&" : "?";
        return `${url}${sep}t=${Date.now()}`;
      }

      // âœ… ç”»åƒæç”»ã‚’é–¢æ•°åŒ–ï¼šåˆå›ãƒ­ãƒ¼ãƒ‰ã§ã‚‚ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã§ã‚‚ã€åŒã˜å‡¦ç†ã§æ›´æ–°
      function renderMedia(url) {
        currentMediaUrl = url || null;

        if (currentMediaUrl) {
          const img = document.createElement("img");
          img.src = withCacheBust(currentMediaUrl);
          img.alt = "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ";

          mediaEl.innerHTML = "";
          mediaEl.appendChild(img);

          openImageBtn.disabled = false;
          imageHintEl.style.display = "block";
        } else {
          mediaEl.innerHTML = "";
          const ph = document.createElement("div");
          ph.className = "media-placeholder";
          ph.textContent = "ç”»åƒURLãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
          mediaEl.appendChild(ph);

          openImageBtn.disabled = true;
          imageHintEl.style.display = "none";
        }
      }

      if (!planId) {
        captionEl.textContent = "";
        errorEl.style.display = "block";
        errorEl.textContent = "plan_id ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚";
        copyBtn.disabled = true;
        openImageBtn.disabled = true;
        setFeedbackButtonsEnabled(false);
      } else {
        setFeedbackButtonsEnabled(false);
        loadPlan(planId);
      }

      async function loadPlan(planId) {
        try {
          captionEl.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
          hashtagsEl.textContent = "";
          errorEl.style.display = "none";

          // plans ã‚’å–å¾—
          const { data: plan, error } = await client
            .from("sns_post_plans")
            .select("plan_id, store_id, platform, scheduled_at, caption, hashtags, media_id, media_public_url")
            .eq("plan_id", planId)
            .maybeSingle();

          if (error) throw error;
          if (!plan) throw new Error("plan ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

          metaEl.textContent = `store: ${plan.store_id} / ${plan.platform} / ${plan.scheduled_at}`;

          renderCaptionAndHashtags(plan.caption, plan.hashtags);

          // ç”»åƒURLï¼ˆå„ªå…ˆ: plan.media_public_url / æ¬¡: media_idâ†’assetsï¼‰
          let finalMediaUrl = plan.media_public_url || null;

          if (!finalMediaUrl && plan.media_id) {
            const { data: asset, error: assetError } = await client
              .from("sns_media_assets")
              .select("storage_bucket, storage_key")
              .eq("media_id", plan.media_id)
              .maybeSingle();

            if (assetError) console.error("assetError", assetError);

            if (asset && asset.storage_bucket && asset.storage_key) {
              const { data: publicUrlData } = client.storage
                .from(asset.storage_bucket)
                .getPublicUrl(asset.storage_key);

              if (publicUrlData && publicUrlData.publicUrl) {
                finalMediaUrl = publicUrlData.publicUrl;
              }
            }
          }

          renderMedia(finalMediaUrl);

          // âœ… planãŒèª­ã‚ãŸã‚‰ãƒœã‚¿ãƒ³ON
          setFeedbackButtonsEnabled(true);
        } catch (e) {
          console.error(e);
          captionEl.textContent = "";
          errorEl.style.display = "block";
          errorEl.textContent = "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
          copyBtn.disabled = true;
          openImageBtn.disabled = true;
          setFeedbackButtonsEnabled(false);
        }
      }

      // STEP2: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚³ãƒ”ãƒ¼
      copyBtn.addEventListener("click", async () => {
        const full = copyBtn.dataset.fulltext || "";
        try {
          await navigator.clipboard.writeText(full);
          copyBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
          setTimeout(() => {
            copyBtn.textContent = "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼";
          }, 1800);
        } catch (e) {
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
          console.error(e);
        }
      });

      // STEP1: ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ãï¼ˆå¸¸ã«ã€Œæœ€æ–°ã®URLã€ã‚’é–‹ãï¼‰
      openImageBtn.addEventListener("click", () => {
        if (!currentMediaUrl) return;
        window.open(withCacheBust(currentMediaUrl), "_blank");
      });

      // STEP3: Instagram
      openInstagramBtn.addEventListener("click", () => {
        // iOS/Androidã§ã®æŒ™å‹•ã¯ç«¯æœ«ä¾å­˜ã€‚ã¾ãšã¯Webã‚’é–‹ãMVPã€‚
        window.open("https://www.instagram.com/", "_blank");
      });

      async function callFeedback(action) {
        const res = await fetch(`${FUNCTIONS_BASE_URL}/sns-preview-feedback`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            plan_id: planId,
            action,
          }),
        });

        const json = await res.json();
        if (!res.ok) {
          throw new Error(json?.error || json?.message || "feedback failed");
        }
        return json; // { caption, hashtags, media_public_url, ... }
      }

      // âœ… å…¨ãƒœã‚¿ãƒ³å…±é€šãƒãƒ³ãƒ‰ãƒ©ï¼ˆdata-actionï¼‰
      document.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!planId) return;

          const action = btn.dataset.action;
          if (!action) return;

          const prevText = btn.textContent;

          try {
            setFeedbackButtonsEnabled(false);
            btn.textContent = "ç”Ÿæˆä¸­...";

            const out = await callFeedback(action);

            // ãƒ†ã‚­ã‚¹ãƒˆã¯å¸¸ã«å³åæ˜ 
            renderCaptionAndHashtags(out.caption, out.hashtags);

            // âœ… ç”»åƒãŒè¿”ã£ã¦ããŸæ™‚ã¯ã€ãã®å ´ã§å·®ã—æ›¿ãˆï¼ˆã“ã“ãŒä»Šå›ã®ã‚­ãƒ¢ï¼‰
            if (out.media_public_url) {
              renderMedia(out.media_public_url);
            }

            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
          } catch (e) {
            console.error(e);
            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
            alert(`å¤±æ•—ï¼š${e?.message || e}`);
          }
        });
      });

      // OKãƒœã‚¿ãƒ³
      document.getElementById("ok-btn").addEventListener("click", () => {
        alert("OKã¨ã—ã¦ç¢ºå®šï¼ˆæ¬¡ã¯ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãªã©ã‚’å®Ÿè£…ã§ãã¾ã™ï¼‰");
      });
    </script>
  </body>
</html>
