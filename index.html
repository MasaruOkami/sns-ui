<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>SNS 投稿プレビュー</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial,
          "YuGothic", "游ゴシック体", sans-serif;
        margin: 0;
        padding: 16px;
        background: #f5f5f7;
      }
      .container {
        max-width: 560px;
        margin: 0 auto;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.06);
        padding: 16px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .meta {
        font-size: 12px;
        color: #777;
        margin-bottom: 12px;
      }
      .media {
        margin: 8px 0 12px;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
        position: relative;
      }
      .media img {
        width: 100%;
        display: block;
        object-fit: cover;
      }
      .media-placeholder {
        padding: 40px 16px;
        text-align: center;
        color: #aaa;
        font-size: 12px;
        background: #111;
      }
      .caption-label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
      }
      .caption-text,
      .hashtags {
        font-size: 14px;
        line-height: 1.7;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .hashtags {
        margin-top: 8px;
      }
      .actions {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .btn-primary {
        background: linear-gradient(135deg, #ff7a00, #ff0069);
        color: #fff;
      }
      .btn-secondary {
        background: #f0f0f5;
        color: #333;
      }
      .hint {
        margin-top: 10px;
        font-size: 11px;
        color: #777;
      }
      .error {
        margin-top: 12px;
        font-size: 13px;
        color: #c62828;
      }
      .loading {
        font-size: 13px;
        color: #555;
      }
    </style>

    <!-- supabase-js v2 (グローバル変数として読み込み) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="title">SNS 投稿プレビュー</div>
        <div id="meta" class="meta"></div>

        <div class="media" id="media">
          <div class="media-placeholder" id="media-placeholder">
            画像がまだ生成されていません。
            <br />generated_media_url が入るとここに表示されます。
          </div>
        </div>

        <div>
          <div class="caption-label">キャプション</div>
          <div id="caption" class="caption-text loading">読み込み中...</div>
          <div id="hashtags" class="hashtags"></div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="copy-btn">
            キャプション＋ハッシュタグをコピー
          </button>
          <button class="btn btn-secondary" id="open-instagram">
            Instagram を開く
          </button>
        </div>

        <div id="hint" class="hint">
          1. まず「コピー」ボタンを押します。<br />
          2. 次に Instagram を開き、投稿画面でペーストしてください。
        </div>

        <div id="error" class="error" style="display: none;"></div>
      </div>
    </div>

    <script>
      // ✅ あなたの Supabase 情報
      const SUPABASE_URL = "https://xzhavuhjpfwsrljkpyrv.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6aGF2dWhqcGZ3c3JsamtweXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODg4MDMsImV4cCI6MjA3Nzg2NDgwM30.h2k2gnOcqme4JSg7VEkpqbIwh27OmdTqX_HkIUTniU4";

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const params = new URLSearchParams(window.location.search);
      const planId = params.get("plan_id");

      const metaEl = document.getElementById("meta");
      const captionEl = document.getElementById("caption");
      const hashtagsEl = document.getElementById("hashtags");
      const errorEl = document.getElementById("error");
      const mediaEl = document.getElementById("media");
      const mediaPlaceholderEl = document.getElementById("media-placeholder");
      const copyBtn = document.getElementById("copy-btn");
      const openInstagramBtn = document.getElementById("open-instagram");

      if (!planId) {
        captionEl.textContent = "";
        errorEl.style.display = "block";
        errorEl.textContent =
          "plan_id が指定されていません。メールのリンクから開いてください。";
        copyBtn.disabled = true;
      } else {
        loadPlan(planId);
      }

      async function loadPlan(planId) {
        try {
          captionEl.textContent = "読み込み中...";
          hashtagsEl.textContent = "";
          errorEl.style.display = "none";

          // ① プラン取得（media_id を追加）
          const { data, error } = await client
            .from("sns_post_plans")
            .select(
              "store_id, platform, media_kind, scheduled_at, caption, hashtags, generated_media_url, posted_url, media_id"
            )
            .eq("plan_id", planId)
            .single();

          if (error || !data) {
            console.error(error);
            captionEl.textContent = "";
            errorEl.style.display = "block";
            errorEl.textContent =
              "プラン情報の取得に失敗しました。リンクが古い可能性があります。";
            copyBtn.disabled = true;
            return;
          }

          // ② メタ表示
          const dt = data.scheduled_at ? new Date(data.scheduled_at) : null;
          const dtStr = dt
            ? `${dt.getFullYear()}/${String(dt.getMonth() + 1).padStart(
                2,
                "0"
              )}/${String(dt.getDate()).padStart(2, "0")} ${String(
                dt.getHours()
              ).padStart(2, "0")}:${String(dt.getMinutes()).padStart(2, "0")}`
            : "日時未設定";

          metaEl.textContent = `${data.store_id} / ${data.platform} / ${data.media_kind} / ${dtStr}`;

          // ③ キャプション・ハッシュタグ
          captionEl.textContent = data.caption || "キャプションが未設定です。";
          const hashtags = (data.hashtags || [])
            .map((h) => (h.startsWith("#") ? h : `#${h}`))
            .join(" ");
          hashtagsEl.textContent = hashtags;

          // ④ 画像URL決定ロジック
          let imageUrl = data.generated_media_url || null;

          // generated_media_url が無くて media_id があれば sns_media_assets から補完
          // ✅ 実テーブルに合わせた版
          if (!imageUrl && data.media_id) {
            try {
              const { data: media, error: mediaError } = await client
                .from("sns_media_assets")
                .select("storage_bucket, storage_key")   // ← カラム名を合わせる
                .eq("media_id", data.media_id)
                .single();
          
              if (!mediaError && media) {
                const { data: urlData } = client.storage
                  .from(media.storage_bucket)           // ← storage_bucket
                  .getPublicUrl(media.storage_key);     // ← storage_key
          
                imageUrl = urlData?.publicUrl || null;
                console.log("resolved imageUrl:", imageUrl);
              } else {
                console.warn("media not found or error", mediaError);
              }
            } catch (resolveErr) {
              console.error("画像URLの解決に失敗しました", resolveErr);
            }
          }

          // ⑤ 画像 or プレースホルダー表示
          if (imageUrl) {
            const img = document.createElement("img");
            img.src = imageUrl;
            img.alt = "プレビュー画像";
            mediaEl.innerHTML = ""; // placeholder を消す
            mediaEl.appendChild(img);
          } else {
            mediaPlaceholderEl.textContent =
              "画像URL（generated_media_url または media_id 経由）がまだ設定されていません。";
          }

          // ⑥ コピー用テキスト
          const fullText = `${captionEl.textContent}\n\n${hashtags}`;
          copyBtn.dataset.fulltext = fullText;
          copyBtn.disabled = false;
        } catch (e) {
          console.error(e);
          captionEl.textContent = "";
          errorEl.style.display = "block";
          errorEl.textContent = "予期しないエラーが発生しました。";
          copyBtn.disabled = true;
        }
      }

      copyBtn.addEventListener("click", async () => {
        const full = copyBtn.dataset.fulltext || "";
        try {
          await navigator.clipboard.writeText(full);
          copyBtn.textContent = "コピーしました";
          setTimeout(() => {
            copyBtn.textContent = "キャプション＋ハッシュタグをコピー";
          }, 1800);
        } catch (e) {
          alert("コピーに失敗しました。手動で選択してコピーしてください。");
          console.error(e);
        }
      });

      openInstagramBtn.addEventListener("click", () => {
        window.location.href = "instagram://app";
        setTimeout(() => {
          window.location.href = "https://www.instagram.com/";
        }, 1200);
      });
    </script>
  </body>
</html>
