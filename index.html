<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial,
          "YuGothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", sans-serif;
        margin: 0;
        padding: 16px;
        background: #f5f5f7;
      }
      .container { max-width: 560px; margin: 0 auto; }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.06);
        padding: 16px;
      }
      .title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
      .meta { font-size: 12px; color: #777; margin-bottom: 16px; }

      .section { margin-top: 16px; }
      .step-label {
        font-size: 11px;
        font-weight: 700;
        color: #ff6a3d;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .section-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; }

      /* ====== Media (Carousel/Video) ====== */
      .media-box{
        border-radius: 12px;
        overflow: hidden;
        background: #111;
        border: 1px solid #eee;
      }
      .media-stage{
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #111;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      #media-img{
        width: 100%;
        height: 100%;
        object-fit: cover;
        display:block;
      }
      .media-placeholder {
        padding: 40px 16px;
        text-align: center;
        color: #aaa;
        font-size: 12px;
        background: #111;
      }

      .nav-btn{
        position:absolute;
        top:50%;
        transform:translateY(-50%);
        width:44px;
        height:44px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.35);
        background:rgba(0,0,0,0.35);
        color:#fff;
        font-size:28px;
        line-height:40px;
        display:none;
        align-items:center;
        justify-content:center;
        cursor:pointer;
      }
      .nav-prev{ left:10px; }
      .nav-next{ right:10px; }
      .nav-btn:active{ transform:translateY(-50%) scale(0.98); }

      .play-btn{
        position:absolute;
        inset:auto auto 12px 12px;
        width:52px;
        height:52px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.35);
        background:rgba(0,0,0,0.35);
        color:#fff;
        font-size:20px;
        cursor:pointer;
        display:none;
      }

      .media-meta{
        padding:10px 12px;
        background:#fff;
      }
      .dots{
        display:flex;
        gap:6px;
        justify-content:center;
        align-items:center;
        margin:6px 0 10px;
      }
      .dot{
        width:8px;
        height:8px;
        border-radius:999px;
        background:#ddd;
      }
      .dot.active{ background:#ff6a3d; }

      .thumbs{
        display:flex;
        gap:8px;
        overflow-x:auto;
        padding-bottom:6px;
        -webkit-overflow-scrolling: touch;
      }
      .thumb{
        width:56px;
        height:40px;
        border-radius:10px;
        overflow:hidden;
        border:1px solid #eee;
        flex:0 0 auto;
        cursor:pointer;
      }
      .thumb img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }
      .thumb.active{
        outline:2px solid #ff6a3d;
        outline-offset:2px;
      }

      .video-link{
        display:block;
        text-align:center;
        padding:10px 12px;
        border-radius:12px;
        border:1px solid #eee;
        background:#fafafa;
        color:#333;
        text-decoration:none;
        margin-top:8px;
      }

      /* ====== Caption/Hashtags ====== */
      .caption-label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 4px; }
      .caption-text, .hashtags {
        font-size: 14px;
        line-height: 1.7;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .hashtags { margin-top: 8px; }

      .actions {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .btn-primary { background: linear-gradient(135deg, #ff7a00, #ff0069); color: #fff; }
      .btn-secondary { background: #f0f0f5; color: #333; }
      .btn-ghost { background: #ffffff; color: #333; border: 1px solid #ddd; }

      .hint { margin-top: 10px; font-size: 11px; color: #777; }
      .hint-small { margin-top: 6px; font-size: 11px; color: #888; }
      .error { margin-top: 12px; font-size: 13px; color: #c62828; }
      .loading { font-size: 13px; color: #555; }

      /* === STEP 2.5 ãƒãƒƒãƒ—UI === */
      .chip-grid { display: flex; flex-wrap: wrap; gap: 8px; }
      .chip {
        border: 1px solid #d9d9de;
        background: #fff;
        color: #333;
        border-radius: 14px;
        padding: 12px 14px;
        font-size: 13px;
        min-height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }
      .chip:hover { background: #fafafa; }
      .chip:disabled { opacity: 0.45; cursor: not-allowed; }
      .chip-ok {
        border-color: #bfe5c8;
        background: #f2fbf5;
        font-weight: 600;
      }
      .subbox{
        margin-top:12px;
        padding:12px;
        border:1px solid #eee;
        border-radius:14px;
        background:#fafafa;
      }
      .subbox-title{
        font-size:13px;
        font-weight:700;
        margin-bottom:10px;
        color:#333;
      }
      .subbox-subtitle{
        margin-top:10px;
        margin-bottom:6px;
        font-size:12px;
        font-weight:600;
        color:#666;
      }
    </style>

    <!-- supabase-js v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <div class="title">SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div id="meta" class="meta"></div>

        <!-- STEP 1: ç”»åƒã‚’ä¿å­˜ -->
        <div class="section">
          <div class="step-label">STEP 1</div>
          <div class="section-title">ç”»åƒã‚’ä¿å­˜</div>

          <!-- Media Preview -->
          <div class="media-box" id="media-box">
            <div class="media-stage">
              <img id="media-img" alt="preview" loading="lazy" style="display:none;" />
              <div class="media-placeholder" id="media-placeholder">
                ç”»åƒ/å‹•ç”»ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br />
                ç”Ÿæˆå¾Œã«ã“ã“ã¸è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>

              <button class="nav-btn nav-prev" id="nav-prev" type="button" aria-label="prev">â€¹</button>
              <button class="nav-btn nav-next" id="nav-next" type="button" aria-label="next">â€º</button>

              <button class="play-btn" id="video-play" type="button" aria-label="play">â–¶ï¸</button>
            </div>

            <div class="media-meta" id="media-meta" style="display:none;">
              <div class="dots" id="dots"></div>
              <div class="thumbs" id="thumbs"></div>
              <a class="video-link" id="video-link" target="_blank" rel="noopener noreferrer" style="display:none;">
                å‹•ç”»ã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã
              </a>
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-ghost" id="open-image-btn" disabled>ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ã</button>
          </div>
          <div class="hint-small" id="image-hint" style="display:none;">
            ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç”»åƒã‚’å…¨ç”»é¢è¡¨ç¤ºã—ã€é•·æŠ¼ã—ã§ã€Œå†™çœŸã‚’ä¿å­˜ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
          </div>
        </div>

        <!-- STEP 2: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ -->
        <div class="section">
          <div class="step-label">STEP 2</div>
          <div class="section-title">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼</div>

          <div class="caption-label">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</div>
          <div id="caption" class="caption-text loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div id="hashtags" class="hashtags"></div>

          <div class="actions">
            <button class="btn btn-primary" id="copy-btn">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
        </div>

        <!-- STEP 2.5: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå†ç”Ÿæˆï¼‰ -->
        <div class="section">
          <div class="step-label">STEP 2.5</div>
          <div class="section-title">æ–‡ç« ãƒ»ç”»åƒã‚’å¾®èª¿æ•´ï¼ˆå†ç”Ÿæˆï¼‰</div>

          <!-- ========== ãƒ†ã‚­ã‚¹ãƒˆèª¿æ•´ ========== -->
          <div class="subbox">
            <div class="subbox-title">ğŸ“ æ–‡ç« ãƒ»ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</div>
            <div class="chip-grid">
              <button class="chip" data-action="shorter_text" type="button" disabled>âœ‚ çŸ­ã</button>
              <button class="chip" data-action="longer_text" type="button" disabled>ğŸ“ é•·ã</button>

              <button class="chip" data-action="less_emoji" type="button" disabled>ğŸ˜¶ çµµæ–‡å­—â†“</button>
              <button class="chip" data-action="more_emoji" type="button" disabled>ğŸ˜ƒ çµµæ–‡å­—â†‘</button>

              <button class="chip" data-action="softer_tone" type="button" disabled>âœï¸ ã‚„ã‚ã‚‰ã‹ã</button>
              <button class="chip" data-action="more_formal" type="button" disabled>ğŸ§‘â€ğŸ’¼ ä¸å¯§ã«</button>
              <button class="chip" data-action="more_friendly" type="button" disabled>ğŸ˜Š è¦ªã—ã¿</button>

              <button class="chip" data-action="adjust_hashtags" type="button" disabled>#ï¸âƒ£ ã‚¿ã‚°èª¿æ•´</button>
            </div>
            <div class="hint-small">æ–‡ç« ãƒ»# ã¯ã™ãåæ˜ ã•ã‚Œã¾ã™ã€‚</div>
          </div>

          <!-- ========== ç”»åƒ/å‹•ç”»èª¿æ•´ ========== -->
          <div class="subbox">
            <div class="subbox-title">ğŸ–¼ ç”»åƒãƒ»å‹•ç”»ï¼ˆãƒªãƒ¼ãƒ«ï¼‰</div>

            <div class="subbox-subtitle">è¢«å†™ä½“</div>
            <div class="chip-grid">
              <button class="chip" data-action="img_subject_food" type="button" disabled>ğŸ½ æ–™ç†</button>
              <button class="chip" data-action="img_subject_drink" type="button" disabled>ğŸ» ãƒ‰ãƒªãƒ³ã‚¯</button>
              <button class="chip" data-action="img_subject_interior" type="button" disabled>ğŸ  åº—å†…</button>
              <button class="chip" data-action="img_subject_staff" type="button" disabled>ğŸ™‚ ã‚¹ã‚¿ãƒƒãƒ•</button>
            </div>

            <div class="subbox-subtitle">æ§‹å›³</div>
            <div class="chip-grid">
              <button class="chip" data-action="img_shot_closeup" type="button" disabled>ğŸ” å¯„ã‚‹</button>
              <button class="chip" data-action="img_shot_wide" type="button" disabled>ğŸ§­ å¼•ã</button>
              <button class="chip" data-action="img_angle_change" type="button" disabled>ğŸ“ è§’åº¦</button>
              <button class="chip" data-action="img_clean_background" type="button" disabled>ğŸ§¼ èƒŒæ™¯</button>
            </div>

            <div class="subbox-subtitle">é›°å›²æ°—</div>
            <div class="chip-grid">
              <button class="chip" data-action="img_mood_bright" type="button" disabled>â˜€ï¸ æ˜ã‚‹ã</button>
              <button class="chip" data-action="img_mood_calm" type="button" disabled>ğŸŒ™ è½ã¡ç€ã</button>
              <button class="chip" data-action="img_mood_luxury" type="button" disabled>âœ¨ é«˜ç´šæ„Ÿ</button>
              <button class="chip" data-action="img_mood_pop" type="button" disabled>ğŸ“¸ æ˜ ãˆ</button>
            </div>

            <div class="subbox-subtitle">ãƒ†ãƒ­ãƒƒãƒ—</div>
            <div class="chip-grid">
              <button class="chip" data-action="img_text_on" type="button" disabled>ğŸ· æœ‰</button>
              <button class="chip" data-action="img_text_off" type="button" disabled>ğŸš« ç„¡</button>
              <button class="chip" data-action="img_variation" type="button" disabled>ğŸ² åˆ¥æ¡ˆ</button>
            </div>

            <div class="hint-small">ç”»åƒ/å‹•ç”»ã¯ç”Ÿæˆã«æ•°ç§’ã‹ã‹ã‚Šã¾ã™ã€‚</div>
          </div>

          <!-- OK -->
          <div class="chip-grid" style="margin-top: 10px;">
            <button class="chip chip-ok" id="ok-btn" type="button" disabled>âœ… ã“ã‚Œã§OK</button>
          </div>

          <div class="hint-small">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ•°ç§’å¾Œã«ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³/ç”»åƒãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚</div>
        </div>

        <!-- STEP 3: Instagram ã‚’é–‹ã -->
        <div class="section">
          <div class="step-label">STEP 3</div>
          <div class="section-title">Instagram ã«è²¼ã‚Šä»˜ã‘</div>
          <div class="actions">
            <button class="btn btn-secondary" id="open-instagram">Instagram ã‚’é–‹ã</button>
          </div>
        </div>

        <div id="hint" class="hint">
          1. ã¾ãšã€Œç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ãã€ã§ç”»åƒã‚’ä¿å­˜<br />
          2. æ¬¡ã«ã€Œã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã€<br />
          3. æœ€å¾Œã« Instagram ã‚’é–‹ãã€æŠ•ç¨¿ç”»é¢ã§ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„
        </div>

        <div id="error" class="error" style="display:none;"></div>
      </div>
    </div>

    <script>
      // âœ… ã‚ãªãŸã® Supabase æƒ…å ±
      const SUPABASE_URL = "https://xzhavuhjpfwsrljkpyrv.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6aGF2dWhqcGZ3c3JsamtweXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODg4MDMsImV4cCI6MjA3Nzg2NDgwM30.h2k2gnOcqme4JSg7VEkpqbIwh27OmdTqX_HkIUTniU4";

      const FUNCTIONS_BASE_URL = `${SUPABASE_URL}/functions/v1`;

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const params = new URLSearchParams(window.location.search);
      const planId = params.get("plan_id");

      const metaEl = document.getElementById("meta");
      const captionEl = document.getElementById("caption");
      const hashtagsEl = document.getElementById("hashtags");
      const errorEl = document.getElementById("error");
      const copyBtn = document.getElementById("copy-btn");
      const openInstagramBtn = document.getElementById("open-instagram");
      const openImageBtn = document.getElementById("open-image-btn");
      const imageHintEl = document.getElementById("image-hint");

      // media UI elements
      const mediaImg = document.getElementById("media-img");
      const mediaPlaceholder = document.getElementById("media-placeholder");
      const mediaMeta = document.getElementById("media-meta");
      const navPrev = document.getElementById("nav-prev");
      const navNext = document.getElementById("nav-next");
      const dotsEl = document.getElementById("dots");
      const thumbsEl = document.getElementById("thumbs");
      const videoPlayBtn = document.getElementById("video-play");
      const videoLink = document.getElementById("video-link");

      // ===== Media state =====
      let MEDIA_URLS = [];
      let MEDIA_INDEX = 0;
      let VIDEO_URL = null;
      let VIDEO_THUMB = null;
      let currentOpenableUrl = null; // "ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ã" ãŒé–‹ãURLï¼ˆç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒï¼‰

      function normalizeHashtags(hashtagsArr) {
        return (hashtagsArr || [])
          .map((h) => String(h || "").trim())
          .filter(Boolean)
          .map((h) => (h.startsWith("#") ? h : `#${h}`))
          .join(" ");
      }

      function renderCaptionAndHashtags(caption, hashtagsArr) {
        captionEl.textContent = caption || "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒæœªè¨­å®šã§ã™ã€‚";
        const hashtags = normalizeHashtags(hashtagsArr);
        hashtagsEl.textContent = hashtags;

        const fullText = `${captionEl.textContent}\n\n${hashtags}`;
        copyBtn.dataset.fulltext = fullText;
      }

      function setFeedbackButtonsEnabled(enabled) {
        document.querySelectorAll("button[data-action], #ok-btn").forEach((btn) => {
          btn.disabled = !enabled;
        });
      }

      // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼ˆç”»åƒå·®ã—æ›¿ãˆã®ç¢ºå®ŸåŒ–ï¼‰
      function withCacheBust(url) {
        if (!url) return url;
        const sep = url.includes("?") ? "&" : "?";
        return `${url}${sep}t=${Date.now()}`;
      }

      // ===== Carousel/Video rendering =====
      function setMediaMode({ kind, urls = [], videoUrl = null, videoThumb = null }) {
        // reset
        MEDIA_URLS = [];
        MEDIA_INDEX = 0;
        VIDEO_URL = null;
        VIDEO_THUMB = null;
        currentOpenableUrl = null;

        // hide controls
        navPrev.style.display = "none";
        navNext.style.display = "none";
        dotsEl.innerHTML = "";
        thumbsEl.innerHTML = "";
        videoPlayBtn.style.display = "none";
        videoLink.style.display = "none";
        videoLink.removeAttribute("href");

        mediaMeta.style.display = "none";
        mediaImg.style.display = "none";
        mediaPlaceholder.style.display = "block";

        openImageBtn.disabled = true;
        imageHintEl.style.display = "none";

        if (kind === "video") {
          VIDEO_URL = videoUrl || null;
          VIDEO_THUMB = videoThumb || null;

          if (VIDEO_THUMB) {
            mediaPlaceholder.style.display = "none";
            mediaImg.style.display = "block";
            mediaImg.src = withCacheBust(VIDEO_THUMB);
            currentOpenableUrl = VIDEO_THUMB; // ã€Œä¿å­˜ç”¨ã«é–‹ãã€ã¯ã‚µãƒ ãƒã‚’é–‹ã
            openImageBtn.disabled = false;
            imageHintEl.style.display = "block";
          }

          // play UIï¼ˆãƒšãƒ¼ã‚¸å†…å†ç”Ÿã¯ã—ãªã„ï¼‰
          videoPlayBtn.style.display = "inline-flex";
          mediaMeta.style.display = "block";

          if (VIDEO_URL) {
            videoLink.href = VIDEO_URL;
            videoLink.style.display = "block";
          }
          return;
        }

        // image / carousel
        MEDIA_URLS = Array.isArray(urls) ? urls.filter(Boolean) : [];
        if (MEDIA_URLS.length === 0) {
          return;
        }

        mediaPlaceholder.style.display = "none";
        mediaImg.style.display = "block";
        mediaMeta.style.display = "block";

        if (MEDIA_URLS.length === 1) {
          mediaImg.src = withCacheBust(MEDIA_URLS[0]);
          currentOpenableUrl = MEDIA_URLS[0];

          openImageBtn.disabled = false;
          imageHintEl.style.display = "block";

          // ä½™è¨ˆãªUIã¯éè¡¨ç¤º
          dotsEl.innerHTML = "";
          thumbsEl.innerHTML = "";
          return;
        }

        // carousel
        navPrev.style.display = "inline-flex";
        navNext.style.display = "inline-flex";

        renderCarouselUI();
        showCarouselIndex(0);

        openImageBtn.disabled = false;
        imageHintEl.style.display = "block";
      }

      function renderCarouselUI() {
        dotsEl.innerHTML = MEDIA_URLS.map((_, i) =>
          `<div class="dot ${i === MEDIA_INDEX ? "active" : ""}" data-i="${i}"></div>`
        ).join("");

        thumbsEl.innerHTML = MEDIA_URLS.map((u, i) => `
          <div class="thumb ${i === MEDIA_INDEX ? "active" : ""}" data-i="${i}">
            <img src="${escapeAttr(withCacheBust(u))}" alt="thumb${i}" loading="lazy" />
          </div>
        `).join("");

        dotsEl.querySelectorAll(".dot").forEach((el) => {
          el.addEventListener("click", () => showCarouselIndex(Number(el.dataset.i)));
        });
        thumbsEl.querySelectorAll(".thumb").forEach((el) => {
          el.addEventListener("click", () => showCarouselIndex(Number(el.dataset.i)));
        });
      }

      function showCarouselIndex(i) {
        if (!MEDIA_URLS.length) return;
        MEDIA_INDEX = Math.max(0, Math.min(i, MEDIA_URLS.length - 1));
        const url = MEDIA_URLS[MEDIA_INDEX];

        mediaImg.src = withCacheBust(url);
        currentOpenableUrl = url;

        dotsEl.querySelectorAll(".dot").forEach((d, idx) => d.classList.toggle("active", idx === MEDIA_INDEX));
        thumbsEl.querySelectorAll(".thumb").forEach((t, idx) => t.classList.toggle("active", idx === MEDIA_INDEX));

        // prefetch next image
        const next = MEDIA_URLS[MEDIA_INDEX + 1];
        if (next) {
          const img = new Image();
          img.src = withCacheBust(next);
        }
      }

      navPrev.addEventListener("click", () => showCarouselIndex(MEDIA_INDEX - 1));
      navNext.addEventListener("click", () => showCarouselIndex(MEDIA_INDEX + 1));

      videoPlayBtn.addEventListener("click", () => {
        if (VIDEO_URL) window.open(VIDEO_URL, "_blank", "noopener");
        else alert("å‹•ç”»URLãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼ˆç”Ÿæˆä¸­/æœªä½œæˆï¼‰");
      });

      function escapeAttr(s) {
        return String(s).replace(/"/g, "&quot;");
      }

      // ====== Boot ======
      if (!planId) {
        captionEl.textContent = "";
        errorEl.style.display = "block";
        errorEl.textContent = "plan_id ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚";
        copyBtn.disabled = true;
        openImageBtn.disabled = true;
        setFeedbackButtonsEnabled(false);
      } else {
        setFeedbackButtonsEnabled(false);
        loadPlan(planId);
      }

      async function loadPlan(planId) {
        try {
          captionEl.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
          hashtagsEl.textContent = "";
          errorEl.style.display = "none";

          // plans ã‚’å–å¾—
          const { data: plan, error } = await client
            .from("sns_post_plans")
            .select("plan_id, store_id, platform, scheduled_at, caption, hashtags, media_id, media_kind")
            .eq("plan_id", planId)
            .maybeSingle();

          if (error) throw error;
          if (!plan) throw new Error("plan ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

          metaEl.textContent = `store: ${plan.store_id} / ${plan.platform} / ${plan.scheduled_at}`;
          renderCaptionAndHashtags(plan.caption, plan.hashtags);

          // ã¾ãšã¯ media_id â†’ sns_media_assets â†’ publicURL ã§1æšè¡¨ç¤ºï¼ˆMVPï¼‰
          let finalMediaUrl = null;

          if (plan.media_id) {
            const { data: asset, error: assetError } = await client
              .from("sns_media_assets")
              .select("storage_bucket, storage_key, public_url, media_urls, video_public_url, video_thumbnail_url")
              .eq("media_id", plan.media_id)
              .maybeSingle();

            if (assetError) console.error("assetError", assetError);

            // ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ï¼ˆmedia_urlsãŒã‚ã‚Œã°å„ªå…ˆï¼‰
            if (asset && Array.isArray(asset.media_urls) && asset.media_urls.length) {
              setMediaMode({ kind: "carousel", urls: asset.media_urls });
              setFeedbackButtonsEnabled(true);
              return;
            }

            // å‹•ç”»ï¼ˆvideo_thumbnail_urlãŒã‚ã‚Œã°è»½é‡è¡¨ç¤ºï¼‰
            if (asset && (asset.video_thumbnail_url || asset.video_public_url)) {
              setMediaMode({
                kind: "video",
                videoUrl: asset.video_public_url || null,
                videoThumb: asset.video_thumbnail_url || null,
              });
              setFeedbackButtonsEnabled(true);
              return;
            }

            // public_urlãŒã‚ã‚Œã°ä½¿ã†ï¼ˆã‚ã‚Œã°ä¸€ç•ªãƒ©ã‚¯ï¼‰
            if (asset && asset.public_url) {
              finalMediaUrl = asset.public_url;
            }

            // storage_bucket/key ã‹ã‚‰ publicUrl ã‚’ä½œã‚‹
            if (!finalMediaUrl && asset && asset.storage_bucket && asset.storage_key) {
              const { data: publicUrlData } = client.storage
                .from(asset.storage_bucket)
                .getPublicUrl(asset.storage_key);

              if (publicUrlData && publicUrlData.publicUrl) {
                finalMediaUrl = publicUrlData.publicUrl;
              }
            }
          }

          if (finalMediaUrl) {
            setMediaMode({ kind: "image", urls: [finalMediaUrl] });
          } else {
            setMediaMode({ kind: "image", urls: [] });
          }

          setFeedbackButtonsEnabled(true);
        } catch (e) {
          console.error(e);
          captionEl.textContent = "";
          errorEl.style.display = "block";
          // ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ã‚ˆã†ã« messageã‚‚å‡ºã™
          errorEl.textContent = `äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e?.message || e}`;
          copyBtn.disabled = true;
          openImageBtn.disabled = true;
          setFeedbackButtonsEnabled(false);
        }
      }

      // STEP2: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚³ãƒ”ãƒ¼
      copyBtn.addEventListener("click", async () => {
        const full = copyBtn.dataset.fulltext || "";
        try {
          await navigator.clipboard.writeText(full);
          copyBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
          setTimeout(() => {
            copyBtn.textContent = "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼";
          }, 1800);
        } catch (e) {
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
          console.error(e);
        }
      });

      // STEP1: ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ãï¼ˆä»Šè¡¨ç¤ºä¸­ã®ç”»åƒã‚’é–‹ãï¼‰
      openImageBtn.addEventListener("click", () => {
        if (!currentOpenableUrl) return;
        window.open(withCacheBust(currentOpenableUrl), "_blank");
      });

      // STEP3: Instagram
      openInstagramBtn.addEventListener("click", () => {
        window.open("https://www.instagram.com/", "_blank");
      });

      async function callFeedback(action) {
        const res = await fetch(`${FUNCTIONS_BASE_URL}/sns-preview-feedback`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            plan_id: planId,
            action,
          }),
        });

        const text = await res.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch (_) {}

        if (!res.ok) {
          // errorã®ä¸­èº«ã‚’è¦‹ãˆã‚‹åŒ–
          const msg = (json && (json.error || json.message || json.detail)) ? (json.error || json.message || json.detail) : text || "feedback failed";
          throw new Error(msg);
        }
        return json || {};
      }

      function applyMediaFromResponse(out) {
        // 1) ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ï¼ˆEdge FunctionãŒmedia_urlsã‚’è¿”ã™å ´åˆï¼‰
        if (Array.isArray(out.media_urls) && out.media_urls.length) {
          setMediaMode({ kind: "carousel", urls: out.media_urls });
          return;
        }

        // 2) å‹•ç”»ï¼ˆè»½é‡ï¼šã‚µãƒ ãƒï¼‹åˆ¥ã‚¿ãƒ–å†ç”Ÿï¼‰
        if (out.video_thumbnail_url || out.video_public_url) {
          setMediaMode({
            kind: "video",
            videoUrl: out.video_public_url || null,
            videoThumb: out.video_thumbnail_url || null,
          });
          return;
        }

        // 3) 1æšï¼ˆä»Šã®ã‚ãªãŸã®Edge FunctionãŒè¿”ã—ã¦ã„ã‚‹ï¼‰
        if (out.media_public_url) {
          setMediaMode({ kind: "image", urls: [out.media_public_url] });
          return;
        }

        // 4) ä½•ã‚‚è¿”ã‚‰ãªã„å ´åˆã¯ç¾çŠ¶ç¶­æŒ
      }

      // âœ… å…¨ãƒœã‚¿ãƒ³å…±é€šãƒãƒ³ãƒ‰ãƒ©ï¼ˆdata-actionï¼‰
      document.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!planId) return;

          const action = btn.dataset.action;
          if (!action) return;

          const prevText = btn.textContent;

          try {
            setFeedbackButtonsEnabled(false);
            btn.textContent = "ç”Ÿæˆä¸­...";

            const out = await callFeedback(action);

            // ãƒ†ã‚­ã‚¹ãƒˆ
            if (out.caption || out.hashtags) {
              renderCaptionAndHashtags(out.caption, out.hashtags);
            }

            // ç”»åƒ/ã‚«ãƒ«ãƒ¼ã‚»ãƒ«/å‹•ç”»
            applyMediaFromResponse(out);

            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
          } catch (e) {
            console.error(e);
            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
            alert(`å¤±æ•—ï¼š${e?.message || e}`);
          }
        });
      });

      // OKãƒœã‚¿ãƒ³
      document.getElementById("ok-btn").addEventListener("click", () => {
        alert("OKã¨ã—ã¦ç¢ºå®šï¼ˆæ¬¡ã¯ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãªã©ã‚’å®Ÿè£…ã§ãã¾ã™ï¼‰");
      });
    </script>
  </body>
</html>
