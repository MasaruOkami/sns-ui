<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>SNS 投稿プレビュー</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial,
          "YuGothic", "游ゴシック体", sans-serif;
        margin: 0;
        padding: 16px;
        background: #f5f5f7;
      }
      .container {
        max-width: 560px;
        margin: 0 auto;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.06);
        padding: 16px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .meta {
        font-size: 12px;
        color: #777;
        margin-bottom: 16px;
      }

      .section {
        margin-top: 16px;
      }
      .step-label {
        font-size: 11px;
        font-weight: 700;
        color: #ff6a3d;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .section-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .media {
        margin: 4px 0 12px;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
        position: relative;
      }
      .media img {
        width: 100%;
        display: block;
        object-fit: cover;
      }
      .media-placeholder {
        padding: 40px 16px;
        text-align: center;
        color: #aaa;
        font-size: 12px;
        background: #111;
      }

      .caption-label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
      }
      .caption-text,
      .hashtags {
        font-size: 14px;
        line-height: 1.7;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .hashtags {
        margin-top: 8px;
      }

      .actions {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .btn-primary {
        background: linear-gradient(135deg, #ff7a00, #ff0069);
        color: #fff;
      }
      .btn-secondary {
        background: #f0f0f5;
        color: #333;
      }
      .btn-ghost {
        background: #ffffff;
        color: #333;
        border: 1px solid #ddd;
      }

      .hint {
        margin-top: 10px;
        font-size: 11px;
        color: #777;
      }
      .hint-small {
        margin-top: 4px;
        font-size: 11px;
        color: #888;
      }
      .error {
        margin-top: 12px;
        font-size: 13px;
        color: #c62828;
      }
      .loading {
        font-size: 13px;
        color: #555;
      }
    </style>

    <!-- supabase-js v2 (グローバル変数として読み込み) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="title">SNS 投稿プレビュー</div>
        <div id="meta" class="meta"></div>

        <!-- STEP 1: 画像を保存 -->
        <div class="section">
          <div class="step-label">STEP 1</div>
          <div class="section-title">画像を保存</div>

          <div class="media" id="media">
            <div class="media-placeholder" id="media-placeholder">
              画像がまだ設定されていません。
              <br />generated_media_url または Storage の画像が入るとここに表示されます。
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-ghost" id="open-image-btn" disabled>
              画像を保存用に開く
            </button>
          </div>
          <div class="hint-small" id="image-hint">
            ボタンを押して画像を全画面表示し、長押しで「写真を保存」を選んでください。
          </div>
        </div>

        <!-- STEP 2: キャプションをコピー -->
        <div class="section">
          <div class="step-label">STEP 2</div>
          <div class="section-title">キャプションをコピー</div>

          <div class="caption-label">キャプション</div>
          <div id="caption" class="caption-text loading">読み込み中...</div>
          <div id="hashtags" class="hashtags"></div>

          <div class="actions">
            <button class="btn btn-primary" id="copy-btn">
              キャプション＋ハッシュタグをコピー
            </button>
          </div>
        </div>

        <!-- STEP 3: Instagram を開く -->
        <div class="section">
          <div class="step-label">STEP 3</div>
          <div class="section-title">Instagram に貼り付け</div>
          <div class="actions">
            <button class="btn btn-secondary" id="open-instagram">
              Instagram を開く
            </button>
          </div>
        </div>

        <div id="hint" class="hint">
          1. まず「画像を保存用に開く」で画像を保存<br />
          2. 次に「キャプション＋ハッシュタグをコピー」<br />
          3. 最後に Instagram を開き、投稿画面でペーストしてください
        </div>

        <div id="error" class="error" style="display: none;"></div>
      </div>
    </div>

    <script>
      // ✅ あなたの Supabase 情報
      const SUPABASE_URL = "https://xzhavuhjpfwsrljkpyrv.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6aGF2dWhqcGZ3c3JsamtweXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODg4MDMsImV4cCI6MjA3Nzg2NDgwM30.h2k2gnOcqme4JSg7VEkpqbIwh27OmdTqX_HkIUTniU4";

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const params = new URLSearchParams(window.location.search);
      const planId = params.get("plan_id");

      const metaEl = document.getElementById("meta");
      const captionEl = document.getElementById("caption");
      const hashtagsEl = document.getElementById("hashtags");
      const errorEl = document.getElementById("error");
      const mediaEl = document.getElementById("media");
      const mediaPlaceholderEl = document.getElementById("media-placeholder");
      const copyBtn = document.getElementById("copy-btn");
      const openInstagramBtn = document.getElementById("open-instagram");
      const openImageBtn = document.getElementById("open-image-btn");
      const imageHintEl = document.getElementById("image-hint");

      let currentMediaUrl = null;

      if (!planId) {
        captionEl.textContent = "";
        errorEl.style.display = "block";
        errorEl.textContent =
          "plan_id が指定されていません。メールのリンクから開いてください。";
        copyBtn.disabled = true;
        openImageBtn.disabled = true;
      } else {
        loadPlan(planId);
      }

      async function loadPlan(planId) {
        try {
          captionEl.textContent = "読み込み中...";
          hashtagsEl.textContent = "";
          errorEl.style.display = "none";

          // 1) プラン情報を取得（media_id も取る）
          const { data: plan, error: planError } = await client
            .from("sns_post_plans")
            .select(
              "store_id, platform, media_kind, scheduled_at, caption, hashtags, generated_media_url, posted_url, media_id"
            )
            .eq("plan_id", planId)
            .single();

          if (planError || !plan) {
            console.error(planError);
            captionEl.textContent = "";
            errorEl.style.display = "block";
            errorEl.textContent =
              "プラン情報の取得に失敗しました。リンクが古い可能性があります。";
            copyBtn.disabled = true;
            openImageBtn.disabled = true;
            return;
          }

          // メタ情報
          const dt = plan.scheduled_at ? new Date(plan.scheduled_at) : null;
          const dtStr = dt
            ? `${dt.getFullYear()}/${String(dt.getMonth() + 1).padStart(
                2,
                "0"
              )}/${String(dt.getDate()).padStart(2, "0")} ${String(
                dt.getHours()
              ).padStart(2, "0")}:${String(dt.getMinutes()).padStart(2, "0")}`
            : "日時未設定";

          metaEl.textContent = `${plan.store_id} / ${plan.platform} / ${plan.media_kind} / ${dtStr}`;

          // キャプション・ハッシュタグ
          captionEl.textContent =
            plan.caption || "キャプションが未設定です。";
          const hashtags = (plan.hashtags || [])
            .map((h) => (h.startsWith("#") ? h : `#${h}`))
            .join(" ");
          hashtagsEl.textContent = hashtags;

          const fullText = `${captionEl.textContent}\n\n${hashtags}`;
          copyBtn.dataset.fulltext = fullText;

          // 2) 画像URLの決定ロジック
          let finalMediaUrl = null;

          if (plan.generated_media_url) {
            // a) generated_media_url が入っている場合はそのまま
            finalMediaUrl = plan.generated_media_url;
          } else if (plan.media_id) {
            // b) media_id があれば sns_media_assets から Storage 情報を取得
            const { data: asset, error: assetError } = await client
              .from("sns_media_assets")
              .select("storage_bucket, storage_key")
              .eq("media_id", plan.media_id)
              .maybeSingle();

            if (assetError) {
              console.error("assetError", assetError);
            }

            if (asset && asset.storage_bucket && asset.storage_key) {
              const { data: publicUrlData } = client.storage
                .from(asset.storage_bucket)
                .getPublicUrl(asset.storage_key);

              if (publicUrlData && publicUrlData.publicUrl) {
                finalMediaUrl = publicUrlData.publicUrl;
              }
            }
          }

          currentMediaUrl = finalMediaUrl;

          if (finalMediaUrl) {
            const img = document.createElement("img");
            img.src = finalMediaUrl;
            img.alt = "プレビュー画像";
            mediaEl.innerHTML = "";
            mediaEl.appendChild(img);

            openImageBtn.disabled = false;
            imageHintEl.style.display = "block";
          } else {
            mediaPlaceholderEl.textContent =
              "画像URLがまだ設定されていません。";
            openImageBtn.disabled = true;
            imageHintEl.style.display = "none";
          }
        } catch (e) {
          console.error(e);
          captionEl.textContent = "";
          errorEl.style.display = "block";
          errorEl.textContent = "予期しないエラーが発生しました。";
          copyBtn.disabled = true;
          openImageBtn.disabled = true;
        }
      }

      // STEP2: キャプションコピー
      copyBtn.addEventListener("click", async () => {
        const full = copyBtn.dataset.fulltext || "";
        try {
          await navigator.clipboard.writeText(full);
          copyBtn.textContent = "コピーしました";
          setTimeout(() => {
            copyBtn.textContent = "キャプション＋ハッシュタグをコピー";
          }, 1800);
        } catch (e) {
          alert("コピーに失敗しました。手動で選択してコピーしてください。");
          console.error(e);
        }
      });

      // STEP1: 画像を保存用に開く（新しいタブで画像URLを開く）
      openImageBtn.addEventListener("click", () => {
        if (!currentMediaUrl) return;
        window.open(currentMediaUrl, "_blank");
      });

      // STEP3: Instagram を開く
      openInstagramBtn.addEventListener("click", () => {
        // Instagram アプリを試す → ダメならWeb
        window.location.href = "instagram://app";
        setTimeout(() => {
          window.location.href = "https://www.instagram.com/";
        }, 1200);
      });
    </script>
  </body>
</html>
