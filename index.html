<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>

    <!-- supabase-js (UMD) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
      :root {
        --bg: #f7f7fb;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --line: #e5e7eb;
        --accent1: #f97316;
        --accent2: #ec4899;
        --okbg: #e8f7ea;
        --okline: #a7e0af;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      }
      .wrap { max-width: 820px; margin: 0 auto; padding: 18px 14px 40px; }
      .card {
        background: var(--card);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
      }
      h1 { margin: 0 0 6px; font-size: 26px; letter-spacing: .02em; }
      .meta { color: var(--muted); font-size: 12px; margin-bottom: 10px; }

      .stepLabel {
        font-size: 14px;
        letter-spacing: .14em;
        font-weight: 800;
        color: var(--accent1);
        margin: 18px 0 6px;
        text-transform: uppercase;
      }
      .stepTitle { margin: 0 0 10px; font-size: 22px; font-weight: 900; }

      /* Media area */
      .mediaBox {
        border-radius: 18px;
        background: #0b0b10;
        overflow: hidden;
        position: relative;
        min-height: 240px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mediaBox img {
        width: 100%;
        height: auto;
        display: block;
      }
      .mediaPlaceholder {
        color: rgba(255,255,255,.7);
        text-align: center;
        padding: 16px;
        line-height: 1.6;
      }

      .mediaControlsRow {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      .pillBtn {
        border: 1px solid var(--line);
        background: #fff;
        padding: 14px 18px;
        border-radius: 999px;
        font-size: 15px;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 2px 0 rgba(0,0,0,.02);
      }
      .pillBtn:disabled { opacity: .45; cursor: not-allowed; }
      .pillBtn.primary {
        border: none;
        background: linear-gradient(90deg, var(--accent1), var(--accent2));
        color: white;
      }

      /* carousel nav */
      .navBtn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.25);
        background: rgba(0,0,0,.35);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        user-select: none;
        backdrop-filter: blur(6px);
      }
      .navBtn:hover { background: rgba(0,0,0,.5); }
      #nav-prev { left: 10px; }
      #nav-next { right: 10px; }

      .dots {
        display: flex;
        gap: 6px;
        justify-content: center;
        margin-top: 10px;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #d1d5db;
        cursor: pointer;
      }
      .dot.active { background: #111827; }

      .thumbs {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 10px 2px 2px;
      }
      .thumb {
        width: 62px;
        height: 62px;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid transparent;
        flex: 0 0 auto;
        background: #111;
        cursor: pointer;
      }
      .thumb.active { border-color: var(--accent2); }
      .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }

      .videoOverlay {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }
      .videoPlay {
        pointer-events: auto;
        display: none;
        position: absolute;
        bottom: 12px;
        right: 12px;
        padding: 12px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.25);
        background: rgba(0,0,0,.45);
        color: #fff;
        font-weight: 900;
        cursor: pointer;
        backdrop-filter: blur(6px);
      }
      .videoLink {
        display: none;
        margin-top: 10px;
        text-align: center;
        font-size: 13px;
        color: var(--muted);
      }
      .videoLink a { color: var(--text); font-weight: 800; }

      /* Caption/Hashtags */
      .captionBox {
        margin-top: 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        padding: 12px;
        background: #fff;
      }
      .captionLabel { font-size: 13px; font-weight: 900; margin-bottom: 6px; color: var(--muted); }
      .captionText { white-space: pre-wrap; line-height: 1.6; font-size: 15px; }
      .hashText { margin-top: 10px; white-space: pre-wrap; color: #374151; font-size: 14px; }

      .bigCopy {
        width: 100%;
        border: none;
        color: white;
        font-size: 18px;
        font-weight: 900;
        padding: 18px 18px;
        border-radius: 999px;
        cursor: pointer;
        background: linear-gradient(90deg, var(--accent1), var(--accent2));
        margin-top: 12px;
      }
      .bigCopy:disabled { opacity: .55; cursor: not-allowed; }

      /* Step 2.5 split */
      .splitWrap { display: grid; gap: 14px; }
      .panel {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 14px;
      }
      .panelTitle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 1000;
        margin-bottom: 10px;
      }
      .btnGrid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }
      @media (max-width: 680px) {
        .btnGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      }
      .miniBtn {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 999px;
        padding: 12px 12px;
        font-weight: 900;
        font-size: 14px;
        cursor: pointer;
        text-align: center;
      }
      .miniBtn:disabled { opacity: .45; cursor: not-allowed; }

      .okRow { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
      .okBtn {
        border: 1px solid var(--okline);
        background: var(--okbg);
        padding: 14px 18px;
        border-radius: 999px;
        font-weight: 1000;
        cursor: pointer;
      }

      .error {
        display: none;
        margin-top: 10px;
        color: #b91c1c;
        font-weight: 800;
      }

      .hint {
        font-size: 13px;
        color: var(--muted);
        margin-top: 10px;
        line-height: 1.5;
      }

      .step3Btn {
        width: 100%;
        border: none;
        border-radius: 999px;
        background: #efeff4;
        padding: 16px;
        font-size: 18px;
        font-weight: 900;
        cursor: pointer;
      }

      .smallList {
        margin: 10px 0 0;
        padding-left: 18px;
        color: var(--muted);
        line-height: 1.6;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <h1>SNS æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
        <div class="meta" id="meta">loading...</div>

        <!-- STEP 1 -->
        <div class="stepLabel">STEP 1</div>
        <div class="stepTitle">ç”»åƒã‚’ä¿å­˜</div>

        <div class="mediaBox" id="media-box">
          <button class="navBtn" id="nav-prev" style="display:none;">â€¹</button>
          <button class="navBtn" id="nav-next" style="display:none;">â€º</button>

          <img id="media-img" alt="preview" style="display:none;" />
          <div class="mediaPlaceholder" id="media-placeholder">
            ç”»åƒãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br />
            generated_media_url / Storage ã®ç”»åƒãŒå…¥ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>

          <button class="videoPlay" id="video-play" style="display:none;">â–¶ å‹•ç”»ã‚’åˆ¥ã‚¿ãƒ–ã§å†ç”Ÿ</button>
        </div>

        <div class="dots" id="dots"></div>
        <div class="thumbs" id="thumbs"></div>

        <div class="mediaControlsRow">
          <button class="pillBtn" id="open-image-btn" disabled>ç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ã</button>
        </div>
        <div class="videoLink" id="video-link" style="display:none;"></div>

        <!-- STEP 2 -->
        <div class="stepLabel">STEP 2</div>
        <div class="stepTitle">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼</div>

        <div class="captionBox">
          <div class="captionLabel">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</div>
          <div class="captionText" id="caption">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div class="hashText" id="hashtags"></div>
        </div>

        <button class="bigCopy" id="copy-btn" disabled>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>

        <!-- STEP 2.5 -->
        <div class="stepLabel">STEP 2.5</div>
        <div class="stepTitle">æ–‡ç« ãƒ»ç”»åƒã‚’å¾®èª¿æ•´ï¼ˆå†ç”Ÿæˆï¼‰</div>

        <div class="splitWrap">
          <!-- Text panel -->
          <div class="panel">
            <div class="panelTitle">âœï¸ æ–‡ç« ã®èª¿æ•´</div>
            <div class="btnGrid">
              <button class="miniBtn" data-action="shorter_text">âœ‚ çŸ­ã</button>
              <button class="miniBtn" data-action="longer_text">ğŸ“ é•·ã</button>
              <button class="miniBtn" data-action="less_emoji">ğŸ™‚ çµµæ–‡å­—â†“</button>
              <button class="miniBtn" data-action="more_emoji">ğŸ˜„ çµµæ–‡å­—â†‘</button>

              <button class="miniBtn" data-action="softer_tone">âœï¸ ã‚„ã‚ã‚‰ã‹ã</button>
              <button class="miniBtn" data-action="more_formal">ğŸ™‡ ä¸å¯§ã«</button>
              <button class="miniBtn" data-action="more_friendly">ğŸ˜Š è¦ªã—ã¿</button>
              <button class="miniBtn" data-action="adjust_hashtags"># ã‚¿ã‚°èª¿æ•´</button>
            </div>
          </div>

          <!-- Media panel -->
          <div class="panel">
            <div class="panelTitle">ğŸ–¼ï¸ ç”»åƒãƒ»å‹•ç”»ã®èª¿æ•´</div>
            <div class="btnGrid">
              <!-- subject -->
              <button class="miniBtn" data-action="img_subject_food">ğŸ½ æ–™ç†ãƒ¡ã‚¤ãƒ³</button>
              <button class="miniBtn" data-action="img_subject_drink">ğŸ» ãƒ‰ãƒªãƒ³ã‚¯</button>
              <button class="miniBtn" data-action="img_subject_interior">ğŸ  åº—å†…</button>
              <button class="miniBtn" data-action="img_subject_staff">ğŸ™‚ ã‚¹ã‚¿ãƒƒãƒ•</button>

              <!-- composition -->
              <button class="miniBtn" data-action="img_shot_closeup">ğŸ” å¯„ã‚‹</button>
              <button class="miniBtn" data-action="img_shot_wide">ğŸ§­ å¼•ã</button>
              <button class="miniBtn" data-action="img_angle_change">ğŸ“ è§’åº¦</button>
              <button class="miniBtn" data-action="img_bg_clean">ğŸ§¼ èƒŒæ™¯ã™ã£ãã‚Š</button>

              <!-- mood -->
              <button class="miniBtn" data-action="img_mood_bright">â˜€ï¸ æ˜ã‚‹ã</button>
              <button class="miniBtn" data-action="img_mood_calm">ğŸŒ™ è½ã¡ç€ã</button>
              <button class="miniBtn" data-action="img_mood_luxury">âœ¨ é«˜ç´šæ„Ÿ</button>
              <button class="miniBtn" data-action="img_mood_social">ğŸ“¸ æ˜ ãˆ</button>

              <!-- text overlay -->
              <button class="miniBtn" data-action="img_text_on">ğŸ· ãƒ†ãƒ­ãƒƒãƒ—æœ‰</button>
              <button class="miniBtn" data-action="img_text_off">ğŸš« ãƒ†ãƒ­ãƒƒãƒ—ç„¡</button>
              <button class="miniBtn" data-action="img_variation">ğŸ² åˆ¥æ¡ˆ</button>
              <button class="miniBtn" data-action="img_regen">ğŸ”„ å†ç”Ÿæˆ</button>
            </div>
          </div>
        </div>

        <div class="okRow">
          <button class="okBtn" id="ok-btn">âœ… ã“ã‚Œã§OK</button>
        </div>

        <div class="hint">
          ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ•°ç§’å¾Œã«ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³/ç”»åƒãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚<br />
          ã†ã¾ãã„ã‹ãªã„å ´åˆã¯ä¸‹ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®Console/Networkã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>

        <div class="error" id="error"></div>

        <!-- STEP 3 -->
        <div class="stepLabel">STEP 3</div>
        <div class="stepTitle">Instagram ã«è²¼ã‚Šä»˜ã‘</div>

        <button class="step3Btn" id="open-instagram">Instagram ã‚’é–‹ã</button>
        <ol class="smallList">
          <li>ã¾ãšã€Œç”»åƒã‚’ä¿å­˜ç”¨ã«é–‹ãã€ã§ç”»åƒã‚’ä¿å­˜</li>
          <li>æ¬¡ã«ã€Œã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã€</li>
          <li>æœ€å¾Œã« Instagram ã‚’é–‹ãã€æŠ•ç¨¿ç”»é¢ã§ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„</li>
        </ol>
      </div>
    </div>

    <script>
      // ========= è¨­å®š =========
      // ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦
      const SUPABASE_URL = "https://xzhavuhjpfwsrljkpyrv.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6aGF2dWhqcGZ3c3JsamtweXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODg4MDMsImV4cCI6MjA3Nzg2NDgwM30.h2k2gnOcqme4JSg7VEkpqbIwh27OmdTqX_HkIUTniU4"; // â†ã‚ãªãŸã®HTMLã§ã¯æ—¢ã«å…¥ã‚Œã¦ã„ã‚‹ã¯ãš
      const FUNCTIONS_BASE_URL = `${SUPABASE_URL}/functions/v1`;

      // ========= util =========
      function qs(name) {
        const u = new URL(location.href);
        return u.searchParams.get(name);
      }
      function bustCache(url) {
        if (!url) return url;
        const sep = url.includes("?") ? "&" : "?";
        return `${url}${sep}t=${Date.now()}`;
      }
      function escapeAttr(s) {
        return String(s).replace(/"/g, "&quot;");
      }

      // ========= supabase client =========
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ========= DOM =========
      const metaEl = document.getElementById("meta");
      const captionEl = document.getElementById("caption");
      const hashtagsEl = document.getElementById("hashtags");
      const errorEl = document.getElementById("error");

      const copyBtn = document.getElementById("copy-btn");
      const openImageBtn = document.getElementById("open-image-btn");

      const mediaBox = document.getElementById("media-box");
      const mediaImg = document.getElementById("media-img");
      const mediaPlaceholder = document.getElementById("media-placeholder");

      const navPrev = document.getElementById("nav-prev");
      const navNext = document.getElementById("nav-next");
      const dotsEl = document.getElementById("dots");
      const thumbsEl = document.getElementById("thumbs");

      const videoPlayBtn = document.getElementById("video-play");
      const videoLinkWrap = document.getElementById("video-link");

      // ========= state =========
      let planId = qs("plan_id");
      let CURRENT_MEDIA_KIND = "image"; // image | carousel | video
      let MEDIA_URLS = [];
      let MEDIA_INDEX = 0;
      let VIDEO_URL = null;
      let VIDEO_THUMB = null;

      function setFeedbackButtonsEnabled(on) {
        document.querySelectorAll("button[data-action]").forEach((btn) => {
          btn.disabled = !on;
        });
      }

      function renderCaptionAndHashtags(caption, hashtags) {
        const cap = caption || "";
        const hs = Array.isArray(hashtags) ? hashtags : (hashtags ? [String(hashtags)] : []);
        captionEl.textContent = cap || "ï¼ˆã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
        hashtagsEl.textContent = hs.length ? hs.map((t) => (t.startsWith("#") ? t : "#" + t)).join(" ") : "";
        copyBtn.dataset.fulltext = `${cap}\n\n${hashtagsEl.textContent}`.trim();
        copyBtn.disabled = false;
      }

      // ========= media UI =========
      function setMediaMode({ kind, urls = [], videoUrl = null, videoThumb = null }) {
        CURRENT_MEDIA_KIND = kind;

        // reset
        MEDIA_URLS = [];
        MEDIA_INDEX = 0;
        VIDEO_URL = null;
        VIDEO_THUMB = null;

        // hide controls
        navPrev.style.display = "none";
        navNext.style.display = "none";
        dotsEl.innerHTML = "";
        thumbsEl.innerHTML = "";
        videoPlayBtn.style.display = "none";
        videoLinkWrap.style.display = "none";
        videoLinkWrap.innerHTML = "";

        // placeholder/img
        mediaImg.style.display = "none";
        mediaPlaceholder.style.display = "block";

        if (kind === "video") {
          VIDEO_URL = videoUrl;
          VIDEO_THUMB = videoThumb;

          if (VIDEO_THUMB) {
            mediaImg.src = bustCache(VIDEO_THUMB);
            mediaImg.style.display = "block";
            mediaPlaceholder.style.display = "none";
          }

          videoPlayBtn.style.display = "inline-flex";
          if (VIDEO_URL) {
            videoLinkWrap.innerHTML = `å‹•ç”»URLï¼š<a href="${escapeAttr(VIDEO_URL)}" target="_blank" rel="noopener">åˆ¥ã‚¿ãƒ–ã§é–‹ã</a>`;
            videoLinkWrap.style.display = "block";
          }
          openImageBtn.disabled = !VIDEO_THUMB;
          return;
        }

        // image / carousel
        MEDIA_URLS = Array.isArray(urls) ? urls.filter(Boolean) : [];
        if (MEDIA_URLS.length === 0) {
          openImageBtn.disabled = true;
          return;
        }

        mediaImg.src = bustCache(MEDIA_URLS[0]);
        mediaImg.style.display = "block";
        mediaPlaceholder.style.display = "none";
        openImageBtn.disabled = false;

        if (MEDIA_URLS.length === 1) return;

        // carousel
        navPrev.style.display = "inline-flex";
        navNext.style.display = "inline-flex";
        renderCarouselUI();
        showCarouselIndex(0);
      }

      function renderCarouselUI() {
        dotsEl.innerHTML = MEDIA_URLS.map((_, i) =>
          `<div class="dot ${i === MEDIA_INDEX ? "active" : ""}" data-i="${i}"></div>`
        ).join("");

        thumbsEl.innerHTML = MEDIA_URLS.map((u, i) => `
          <div class="thumb ${i === MEDIA_INDEX ? "active" : ""}" data-i="${i}">
            <img src="${escapeAttr(bustCache(u))}" alt="thumb${i}" loading="lazy" />
          </div>
        `).join("");

        dotsEl.querySelectorAll(".dot").forEach((el) => {
          el.addEventListener("click", () => showCarouselIndex(Number(el.dataset.i)));
        });
        thumbsEl.querySelectorAll(".thumb").forEach((el) => {
          el.addEventListener("click", () => showCarouselIndex(Number(el.dataset.i)));
        });
      }

      function showCarouselIndex(i) {
        if (!MEDIA_URLS.length) return;
        MEDIA_INDEX = Math.max(0, Math.min(i, MEDIA_URLS.length - 1));
        mediaImg.src = bustCache(MEDIA_URLS[MEDIA_INDEX]);

        dotsEl.querySelectorAll(".dot").forEach((d, idx) => d.classList.toggle("active", idx === MEDIA_INDEX));
        thumbsEl.querySelectorAll(".thumb").forEach((t, idx) => t.classList.toggle("active", idx === MEDIA_INDEX));

        // prefetch next
        const next = MEDIA_URLS[MEDIA_INDEX + 1];
        if (next) {
          const img = new Image();
          img.src = bustCache(next);
        }
      }

      navPrev.addEventListener("click", () => showCarouselIndex(MEDIA_INDEX - 1));
      navNext.addEventListener("click", () => showCarouselIndex(MEDIA_INDEX + 1));

      videoPlayBtn.addEventListener("click", () => {
        if (VIDEO_URL) window.open(VIDEO_URL, "_blank", "noopener");
        else alert("å‹•ç”»URLãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼ˆç”Ÿæˆä¸­/æœªä½œæˆï¼‰");
      });

      openImageBtn.addEventListener("click", () => {
        if (CURRENT_MEDIA_KIND === "video") {
          if (VIDEO_THUMB) window.open(VIDEO_THUMB, "_blank", "noopener");
          return;
        }
        if (MEDIA_URLS.length) window.open(MEDIA_URLS[MEDIA_INDEX] || MEDIA_URLS[0], "_blank", "noopener");
      });

      // ========= DB fetch: asset ã‚’ â€œå£Šã‚Œãªã„â€ å–å¾— =========
      async function fetchAssetSafe(media_id) {
        if (!media_id) return null;

        // â‘  ã¾ãšã€Œæ–°ã—ã„æƒ³å®šã€ã®select
        const trySelects = [
          "media_id, storage_bucket, storage_key, public_url, media_urls, video_public_url, video_thumbnail_url",
          "media_id, storage_bucket, storage_key, public_url",
          "media_id, storage_bucket, storage_key",
        ];

        for (const sel of trySelects) {
          const { data, error } = await client
            .from("sns_media_assets")
            .select(sel)
            .eq("media_id", media_id)
            .maybeSingle();

          if (!error) return data;

          // column not exist / schema mismatch ã¯æ¬¡ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¸
          const msg = (error && (error.message || "")) || "";
          if (!/does not exist|42703/i.test(msg)) {
            console.error("fetchAssetSafe error", error);
            return null;
          }
        }
        return null;
      }

      function normalizeMaybeArray(v) {
        // jsonb array -> Array
        if (Array.isArray(v)) return v;
        // textã®JSONæ–‡å­—åˆ— -> Array
        if (typeof v === "string") {
          try {
            const x = JSON.parse(v);
            if (Array.isArray(x)) return x;
          } catch (_) {}
        }
        return null;
      }

      function buildPublicUrlFromStorage(bucket, key) {
        if (!bucket || !key) return null;
        const { data } = client.storage.from(bucket).getPublicUrl(key);
        return data?.publicUrl || null;
      }

      // ========= load plan =========
      async function loadPlan(planId) {
        try {
          captionEl.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
          hashtagsEl.textContent = "";
          errorEl.style.display = "none";
          copyBtn.disabled = true;
          openImageBtn.disabled = true;
          setFeedbackButtonsEnabled(false);

          const { data: plan, error } = await client
            .from("sns_post_plans")
            .select("plan_id, store_id, platform, scheduled_at, caption, hashtags, media_id, media_kind")
            .eq("plan_id", planId)
            .maybeSingle();

          if (error) throw error;
          if (!plan) throw new Error("plan ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

          metaEl.textContent = `store: ${plan.store_id} / ${plan.platform} / ${plan.scheduled_at}`;
          renderCaptionAndHashtags(plan.caption, plan.hashtags);

          // åˆæœŸãƒ¡ãƒ‡ã‚£ã‚¢è¡¨ç¤ºï¼ˆmedia_id -> sns_media_assetsï¼‰
          let shown = false;

          if (plan.media_id) {
            const asset = await fetchAssetSafe(plan.media_id);

            if (asset) {
              // 1) carousel
              const arr = normalizeMaybeArray(asset.media_urls);
              if (arr && arr.length) {
                setMediaMode({ kind: "carousel", urls: arr });
                shown = true;
              }

              // 2) video
              if (!shown && (asset.video_thumbnail_url || asset.video_public_url)) {
                setMediaMode({
                  kind: "video",
                  videoUrl: asset.video_public_url || null,
                  videoThumb: asset.video_thumbnail_url || null,
                });
                shown = true;
              }

              // 3) single image
              if (!shown) {
                const url = asset.public_url || buildPublicUrlFromStorage(asset.storage_bucket, asset.storage_key);
                if (url) {
                  setMediaMode({ kind: "image", urls: [url] });
                  shown = true;
                }
              }
            }
          }

          if (!shown) {
            setMediaMode({ kind: "image", urls: [] }); // placeholder
          }

          setFeedbackButtonsEnabled(true);
        } catch (e) {
          console.error(e);
          captionEl.textContent = "";
          errorEl.style.display = "block";
          errorEl.textContent = `äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e?.message || e}`;
          setFeedbackButtonsEnabled(false);
        }
      }

      // ========= feedback call =========
      async function callFeedback(action) {
        const res = await fetch(`${FUNCTIONS_BASE_URL}/sns-preview-feedback`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({ plan_id: planId, action }),
        });

        const text = await res.text().catch(() => "");
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch (_) {}

        if (!res.ok) {
          const msg = (json && (json.error || json.message || json.detail)) ? (json.error || json.message || json.detail) : (text || "feedback failed");
          throw new Error(msg);
        }
        return json || {};
      }

      function applyMediaFromResponse(out) {
        // âœ… Edge Functionãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœ€å„ªå…ˆï¼ˆã“ã“ãŒè¶…é‡è¦ï¼‰
        // 1) carousel
        if (Array.isArray(out.media_urls) && out.media_urls.length) {
          setMediaMode({ kind: "carousel", urls: out.media_urls });
          return;
        }

        // 2) video
        if (out.video_thumbnail_url || out.video_public_url) {
          setMediaMode({
            kind: "video",
            videoUrl: out.video_public_url || null,
            videoThumb: out.video_thumbnail_url || null,
          });
          return;
        }

        // 3) single image
        if (out.media_public_url) {
          setMediaMode({ kind: "image", urls: [out.media_public_url] });
          return;
        }

        // 4) ã‚‚ã— media_id ã ã‘å¢—ãˆã¦URLãŒç„¡ã„å ´åˆã¯DBã‚’å¼•ãç›´ã™ï¼ˆä¿é™ºï¼‰
        if (out.media_id) {
          fetchAssetSafe(out.media_id).then((asset) => {
            if (!asset) return;
            const arr = normalizeMaybeArray(asset.media_urls);
            if (arr && arr.length) {
              setMediaMode({ kind: "carousel", urls: arr });
              return;
            }
            if (asset.video_thumbnail_url || asset.video_public_url) {
              setMediaMode({ kind: "video", videoUrl: asset.video_public_url || null, videoThumb: asset.video_thumbnail_url || null });
              return;
            }
            const url = asset.public_url || buildPublicUrlFromStorage(asset.storage_bucket, asset.storage_key);
            if (url) setMediaMode({ kind: "image", urls: [url] });
          });
        }
      }

      // ========= events =========
      document.getElementById("open-instagram").addEventListener("click", () => {
        window.open("https://www.instagram.com/", "_blank");
      });

      copyBtn.addEventListener("click", async () => {
        const full = copyBtn.dataset.fulltext || "";
        try {
          await navigator.clipboard.writeText(full);
          copyBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
          setTimeout(() => (copyBtn.textContent = "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼"), 1800);
        } catch (e) {
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
          console.error(e);
        }
      });

      document.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const action = btn.dataset.action;
          const prevText = btn.textContent;

          try {
            errorEl.style.display = "none";
            setFeedbackButtonsEnabled(false);
            btn.textContent = "ç”Ÿæˆä¸­...";
            const out = await callFeedback(action);

            // âœ… text update
            if (typeof out.caption !== "undefined" || typeof out.hashtags !== "undefined") {
              renderCaptionAndHashtags(out.caption, out.hashtags);
            }

            // âœ… media update
            applyMediaFromResponse(out);

            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
          } catch (e) {
            console.error(e);
            btn.textContent = prevText;
            setFeedbackButtonsEnabled(true);
            errorEl.style.display = "block";
            errorEl.textContent = `å¤±æ•—ï¼š${e?.message || e}`;
            alert(`å¤±æ•—ï¼š${e?.message || e}`);
          }
        });
      });

      document.getElementById("ok-btn").addEventListener("click", () => {
        alert("OKã¨ã—ã¦ç¢ºå®šï¼ˆæ¬¡ã¯ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãªã©ã‚’å®Ÿè£…ã§ãã¾ã™ï¼‰");
      });

      // ========= init =========
      if (!planId) {
        errorEl.style.display = "block";
        errorEl.textContent = "plan_id ãŒURLã«ã‚ã‚Šã¾ã›ã‚“";
        setFeedbackButtonsEnabled(false);
      } else {
        loadPlan(planId);
      }
    </script>
  </body>
</html>
